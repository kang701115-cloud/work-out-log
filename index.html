<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Log</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">

  <style>
    * { box-sizing:border-box; }
    body {
      margin:0; padding:20px;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f3f4f6;
      display:flex; justify-content:center;
    }
    .container {
      width:100%; max-width:620px;
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 16px 28px rgba(0,0,0,0.12);
    }

    h1 { margin:0; font-size:22px; font-weight:700; }
    label { font-size:12px; color:#374151; }
    input, select {
      width:100%; padding:8px;
      border-radius:10px; border:1px solid #d1d5db;
      font-size:13px;
    }

    .inline-group { display:flex; gap:6px; }
    .section-title { margin-top:20px; font-weight:600; }

    button {
      border:none; border-radius:10px;
      padding:10px; font-size:14px; font-weight:600;
      cursor:pointer; width:100%;
    }
    .btn-primary { background:#2563eb; color:white; }
    .btn-ghost { background:#f9fafb; border:1px solid #d1d5db; }

    .accordion-date {
      background:#eef2ff;
      border:1px solid #c7d2fe;
      padding:10px 14px;
      border-radius:10px;
      margin-top:12px;
      font-weight:600;
      cursor:pointer;
      display:flex; justify-content:space-between; align-items:center;
    }
    .accordion-content {
      display:none;
      flex-direction:column;
      gap:8px;
      background:#fafafa;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
    }

    .exercise-group {
      background:white;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:8px 10px;
    }
    .exercise-title { font-weight:600; margin-bottom:6px; }
    .exercise-line {
      display:flex; justify-content:space-between; align-items:center;
    }
    .edit-btn { color:#2563eb; cursor:pointer; font-size:12px; margin-left:8px; }
    .delete-btn { color:#dc2626; cursor:pointer; font-size:12px; margin-left:8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Workout Log</h1>

  <!-- 날짜 입력 -->
  <label style="margin-top:12px;">날짜</label>
  <input type="date" id="dateInput" style="margin-bottom:14px">

  <!-- 운동 입력 영역 -->
  <div class="section-title">오늘 운동 입력</div>
  <div class="card" style="background:#f9fafb; padding:14px; border-radius:12px; border:1px solid #e5e7eb;">
    <label>운동 선택</label>
    <select id="exerciseSelect" style="margin-bottom:10px;">
      <option>스쿼트</option>
      <option>레그 익스텐션</option>
      <option>라잉 레그컬</option>
      <option>팩덱 플라이</option>
      <option>크런치</option>
      <option>레그 레이즈</option>
      <option>플랭크</option>
      <option>스텝밀</option>
      <option>인터벌 러닝</option>
      <option value="custom">그 외 운동 (직접 입력)</option>
    </select>

    <div id="dynamicInputs"></div>

    <button class="btn-ghost" id="clearCurrentBtn" style="margin-top:10px;">입력 초기화</button>
    <button class="btn-primary" id="addEntryBtn" style="margin-top:6px;">표에 추가</button>
  </div>

  <!-- 오늘 운동 -->
  <div class="section-title">오늘 운동</div>
  <div id="todayArea" style="min-height:50px; background:white; border:1px solid #e5e7eb; border-radius:10px; padding:10px;">
    아직 추가된 운동 없음
  </div>

  <button class="btn-ghost" id="clearTodayBtn" style="margin-top:10px;">오늘 운동 비우기</button>
  <button class="btn-primary" id="finishDayBtn" style="margin-top:6px;">오늘 운동 저장</button>

  <!-- 백업 / 복원 -->
  <button class="btn-ghost" id="backupBtn" style="margin-top:16px;">백업(JSON)</button>
  <button class="btn-ghost" id="restoreBtn" style="margin-top:6px;">복원(JSON)</button>
  <input type="file" id="restoreInput" accept=".json" style="display:none">

  <!-- 기록 -->
  <div class="section-title" style="margin-top:24px;">저장된 운동 기록</div>
  <div id="logAccordion"></div>

</div>

<script>
window.onload = function() {

  /* DOM 캐싱 */
  const dateInput = document.getElementById("dateInput");
  const exerciseSelect = document.getElementById("exerciseSelect");
  const dynamicInputs = document.getElementById("dynamicInputs");
  const todayArea = document.getElementById("todayArea");
  const logAccordion = document.getElementById("logAccordion");
  const addEntryBtn = document.getElementById("addEntryBtn");
  const clearCurrentBtn = document.getElementById("clearCurrentBtn");
  const clearTodayBtn = document.getElementById("clearTodayBtn");
  const finishDayBtn = document.getElementById("finishDayBtn");
  const backupBtn = document.getElementById("backupBtn");
  const restoreBtn = document.getElementById("restoreBtn");
  const restoreInput = document.getElementById("restoreInput");

  /* 데이터 */
  let todayEntries = [];
  let saved = JSON.parse(localStorage.getItem("workout_log_single") || "[]");
  let editTarget = null;

  /* 기본 날짜 */
  dateInput.value = new Date().toISOString().split("T")[0];

  /* 운동 규칙 */
  const CONFIG = {
    "스쿼트":"weight",
    "레그 익스텐션":"weight",
    "라잉 레그컬":"weight",
    "팩덱 플라이":"weight",
    "크런치":"repsOnly",
    "레그 레이즈":"repsOnly",
    "플랭크":"plank",
    "스텝밀":"time",
    "인터벌 러닝":"distanceOnly"
  };

  /* ---- 동적 입력칸 ---- */
  function renderDynamicInputs() {
    const type = CONFIG[exerciseSelect.value];

    if (exerciseSelect.value === "custom") {
      dynamicInputs.innerHTML = `
        <label>운동명</label>
        <input id="c_name" type="text" placeholder="운동 이름">

        <label style="margin-top:8px;">중량 / 세트 / 횟수</label>
        <div class="inline-group">
          <input id="c_weight" type="number" placeholder="kg">
          <input id="c_sets" type="number" placeholder="세트">
          <input id="c_reps" type="number" placeholder="횟수">
        </div>

        <label style="margin-top:8px;">거리(km)</label>
        <input id="c_dist" type="number" step="0.1" placeholder="km">

        <label style="margin-top:8px;">시간</label>
        <div class="inline-group">
          <input id="c_min" type="number" placeholder="분">
          <input id="c_sec" type="number" placeholder="초">
        </div>`;
      return;
    }

    if (type === "weight") {
      dynamicInputs.innerHTML = `
        <label>중량 / 세트 / 횟수</label>
        <div class="inline-group">
          <input id="weight" type="number" placeholder="kg">
          <input id="sets" type="number" placeholder="세트">
          <input id="reps" type="number" placeholder="횟수">
        </div>`;
    } else if (type === "repsOnly") {
      dynamicInputs.innerHTML = `
        <label>세트 / 횟수</label>
        <div class="inline-group">
          <input id="sets" type="number" placeholder="세트">
          <input id="reps" type="number" placeholder="횟수">
        </div>`;
    } else if (type === "plank") {
      dynamicInputs.innerHTML = `
        <label>세트 / 초</label>
        <div class="inline-group">
          <input id="sets" type="number" placeholder="세트">
          <input id="seconds" type="number" placeholder="초">
        </div>`;
    } else if (type === "time") {
      dynamicInputs.innerHTML = `
        <label>시간(분)</label>
        <input id="time" type="number" placeholder="분">`;
    } else if (type === "distanceOnly") {
      dynamicInputs.innerHTML = `
        <label>거리(km)</label>
        <input id="distance" type="number" placeholder="km">`;
    }
  }

  renderDynamicInputs();
  exerciseSelect.onchange = renderDynamicInputs;

  /* ---- 운동 추가 ---- */
  function addEntry() {
    const selected = exerciseSelect.value;
    let entry = {};

    if (selected === "custom") {
      const name = document.getElementById("c_name").value.trim();
      if (!name) return alert("운동명을 입력하세요.");

      entry = {
        ex: name,
        custom:true,
        weight:+document.getElementById("c_weight").value || null,
        sets:+document.getElementById("c_sets").value || null,
        reps:+document.getElementById("c_reps").value || null,
        dist:+document.getElementById("c_dist").value || null,
        timeMin:+document.getElementById("c_min").value || null,
        timeSec:+document.getElementById("c_sec").value || null,
      };
    } else {
      const type = CONFIG[selected];
      entry.ex = selected;
      entry.type = type;

      if (type === "weight") {
        entry.weight = +document.getElementById("weight").value;
        entry.sets = +document.getElementById("sets").value;
        entry.reps = +document.getElementById("reps").value;
        if (!entry.weight || !entry.sets || !entry.reps) return alert("필수값 입력");
      }
      if (type === "repsOnly") {
        entry.sets = +document.getElementById("sets").value;
        entry.reps = +document.getElementById("reps").value;
        if (!entry.sets || !entry.reps) return alert("필수값 입력");
      }
      if (type === "plank") {
        entry.sets = +document.getElementById("sets").value;
        entry.seconds = +document.getElementById("seconds").value;
        if (!entry.sets || !entry.seconds) return alert("필수값 입력");
      }
      if (type === "time") {
        entry.time = +document.getElementById("time").value;
        if (!entry.time) return alert("시간 입력");
      }
      if (type === "distanceOnly") {
        entry.dist = +document.getElementById("distance").value;
        if (!entry.dist) return alert("거리 입력");
      }
    }

    if (editTarget) {
      saved[editTarget.di].items[editTarget.ii] = entry;
      saveLocal();
      editTarget = null;
      addEntryBtn.textContent = "표에 추가";
      renderSaved();
      return;
    }

    todayEntries.push(entry);
    renderToday();
    renderDynamicInputs();
  }

  /* ---- 포맷 ---- */
  function formatEntry(e) {
    if (e.custom) {
      let out = e.ex+" — ";
      if (e.weight) out += `${e.weight}kg `;
      if (e.sets && e.reps) out += `${e.sets}×${e.reps} `;
      if (e.dist) out += `${e.dist}km `;
      if (e.timeMin) out += `${e.timeMin}분 `;
      if (e.timeSec) out += `${e.timeSec}초 `;
      return out.trim();
    }

    let out = e.ex+" — ";
    if (e.type==="weight") out += `${e.weight}kg ${e.sets}×${e.reps}`;
    if (e.type==="repsOnly") out += `${e.sets}×${e.reps}`;
    if (e.type==="plank") out += `${e.sets}×${e.seconds}초`;
    if (e.type==="time") out += `${e.time}분`;
    if (e.type==="distanceOnly") out += `${e.dist}km`;
    return out;
  }

  /* ---- 오늘 운동 렌더링 ---- */
  function renderToday() {
    if (!todayEntries.length) {
      todayArea.textContent = "아직 추가된 운동 없음";
      return;
    }
    todayArea.innerHTML = todayEntries.map(e=>`<div>${formatEntry(e)}</div>`).join("");
  }

  /* ---- 저장 ---- */
  function finishDay() {
    if (!todayEntries.length) return alert("운동 없음");
    const date = dateInput.value;

    let exist = saved.find(s=>s.date===date);
    if (exist) exist.items.push(...todayEntries);
    else saved.push({date, items:[...todayEntries]});

    saveLocal();
    todayEntries = [];
    renderToday();
    renderSaved();
  }

  /* ---- 기록 렌더 ---- */
  function renderSaved() {
    logAccordion.innerHTML = "";

    if (!saved.length) {
      logAccordion.innerHTML = `<div style="color:#6b7280;">기록 없음</div>`;
      return;
    }

    [...saved].sort((a,b)=>b.date.localeCompare(a.date))
      .forEach((session, di)=> {
        const head = document.createElement("div");
        head.className = "accordion-date";
        head.innerHTML = `${session.date}<span>▶</span>`;

        const content = document.createElement("div");
        content.className = "accordion-content";

        const groups = {};
        session.items.forEach((e,ii)=>{
          if (!groups[e.ex]) groups[e.ex] = [];
          groups[e.ex].push({...e, ii});
        });

        Object.keys(groups).forEach(ex=>{
          const box = document.createElement("div");
          box.className = "exercise-group";

          box.innerHTML = `<div class="exercise-title">${ex}</div>`;

          groups[ex].forEach(e=>{
            const line = document.createElement("div");
            line.className = "exercise-line";
            line.innerHTML = `
              <span>${formatEntry(e)}</span>
              <span>
                <span class="edit-btn" onclick="editEntry(${di},${e.ii})">수정</span>
                <span class="delete-btn" onclick="deleteEntry(${di},${e.ii})">삭제</span>
              </span>
            `;
            box.appendChild(line);
          });

          content.appendChild(box);
        });

        head.onclick = ()=>{
          const open = content.style.display==="flex";
          content.style.display = open ? "none" : "flex";
          head.querySelector("span").textContent = open ? "▶" : "▼";
        };

        logAccordion.appendChild(head);
        logAccordion.appendChild(content);
      });
  }

  renderSaved();

  /* ---- 수정 ---- */
  window.editEntry = function(di,ii){
    editTarget = {di, ii};
    const e = saved[di].items[ii];

    exerciseSelect.value = e.custom ? "custom" : e.ex;
    renderDynamicInputs();

    if (e.custom) {
      document.getElementById("c_name").value = e.ex;
      document.getElementById("c_weight").value = e.weight || "";
      document.getElementById("c_sets").value = e.sets || "";
      document.getElementById("c_reps").value = e.reps || "";
      document.getElementById("c_dist").value = e.dist || "";
      document.getElementById("c_min").value = e.timeMin || "";
      document.getElementById("c_sec").value = e.timeSec || "";
    } else {
      if (e.type==="weight") {
        document.getElementById("weight").value = e.weight;
        document.getElementById("sets").value = e.sets;
        document.getElementById("reps").value = e.reps;
      }
      if (e.type==="repsOnly") {
        document.getElementById("sets").value = e.sets;
        document.getElementById("reps").value = e.reps;
      }
      if (e.type==="plank") {
        document.getElementById("sets").value = e.sets;
        document.getElementById("seconds").value = e.seconds;
      }
      if (e.type==="time") {
        document.getElementById("time").value = e.time;
      }
      if (e.type==="distanceOnly") {
        document.getElementById("distance").value = e.dist;
      }
    }

    addEntryBtn.textContent = "수정 저장";
  };

  /* ---- 삭제 ---- */
  window.deleteEntry = function(di,ii){
    if (!confirm("삭제할까요?")) return;
    saved[di].items.splice(ii,1);
    if (saved[di].items.length===0) saved.splice(di,1);
    saveLocal();
    renderSaved();
  };

  /* ---- 로컬 저장 ---- */
  function saveLocal(){
    localStorage.setItem("workout_log_single", JSON.stringify(saved));
  }

  /* ---- 오늘 운동 비우기 ---- */
  clearTodayBtn.onclick = ()=>{
    todayEntries = [];
    renderToday();
  };

  clearCurrentBtn.onclick = ()=>{
    editTarget=null;
    addEntryBtn.textContent="표에 추가";
    renderDynamicInputs();
  };

  addEntryBtn.onclick = addEntry;
  finishDayBtn.onclick = finishDay;

  /* ---- 백업 ---- */
  backupBtn.onclick = ()=>{
    const blob = new Blob([JSON.stringify({saved},null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "workout_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  /* ---- 복원 ---- */
  restoreBtn.onclick = ()=> restoreInput.click();
  restoreInput.onchange = e=>{
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{
      try {
        saved = JSON.parse(reader.result).saved || [];
        saveLocal();
        renderSaved();
        alert("복원 완료!");
      } catch {
        alert("JSON 오류");
      }
    };
    reader.readAsText(file);
  };

  /* ---- PWA ---- */
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }

}; // window.onload 끝
</script>

</body>
</html>
