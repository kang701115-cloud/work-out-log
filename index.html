/* ---------------- 변수 ---------------- */
let todayEntries = [];
let saved = [];
let editTarget = null;
const STORAGE_KEY = "workout_log_single";

/* 기본 날짜 설정 */
dateInput.value = new Date().toISOString().split("T")[0];

/* 운동 규칙 */
const CONFIG = {
  "스쿼트":"weight",
  "레그 익스텐션":"weight",
  "라잉 레그컬":"weight",
  "팩덱 플라이":"weight",
  "크런치":"repsOnly",
  "레그 레이즈":"repsOnly",
  "플랭크":"plank",
  "스텝밀":"time",
  "인터벌 러닝":"distanceOnly"
};

/* ---------------- 동적 입력칸 ---------------- */
function renderDynamicInputs() {
  const type = CONFIG[exerciseSelect.value];
  const box = dynamicInputs;

  if (exerciseSelect.value === "custom") {
    box.innerHTML = `
      <label>운동명</label>
      <input id="c_name" type="text" placeholder="운동 이름 입력">

      <label style="margin-top:8px;">중량 / 세트 / 횟수</label>
      <div class="inline-group">
        <input id="c_weight" type="number" placeholder="kg">
        <input id="c_sets" type="number" placeholder="세트">
        <input id="c_reps" type="number" placeholder="횟수">
      </div>

      <label style="margin-top:8px;">거리(km)</label>
      <input id="c_dist" type="number" step="0.1" placeholder="km">

      <label style="margin-top:8px;">시간</label>
      <div class="inline-group">
        <input id="c_min" type="number" placeholder="분">
        <input id="c_sec" type="number" placeholder="초">
      </div>
    `;
    return;
  }

  if (type === "weight") {
    box.innerHTML = `
      <label>중량 / 세트 / 횟수</label>
      <div class="inline-group">
        <input id="weight" type="number" placeholder="kg">
        <input id="sets" type="number" placeholder="세트">
        <input id="reps" type="number" placeholder="횟수">
      </div>`;
  }
  else if (type === "repsOnly") {
    box.innerHTML = `
      <label>세트 / 횟수</label>
      <div class="inline-group">
        <input id="sets" type="number" placeholder="세트">
        <input id="reps" type="number" placeholder="횟수">
      </div>`;
  }
  else if (type === "plank") {
    box.innerHTML = `
      <label>세트 / 초</label>
      <div class="inline-group">
        <input id="sets" type="number" placeholder="세트">
        <input id="seconds" type="number" placeholder="초">
      </div>`;
  }
  else if (type === "time") {
    box.innerHTML = `
      <label>시간(분)</label>
      <input id="time" type="number" placeholder="분">`;
  }
  else if (type === "distanceOnly") {
    box.innerHTML = `
      <label>거리(km)</label>
      <input id="distance" type="number" placeholder="km">`;
  }
}
renderDynamicInputs();
exerciseSelect.onchange = renderDynamicInputs;


/* ---------------- 오늘 운동 추가 ---------------- */
function addEntry() {
  const selected = exerciseSelect.value;
  let entry = {};

  if (selected === "custom") {
    const name = c_name.value.trim();
    if (!name) return alert("운동명을 입력하세요.");

    entry = {
      ex: name,
      custom: true,
      weight: +c_weight.value || null,
      sets: +c_sets.value || null,
      reps: +c_reps.value || null,
      dist: +c_dist.value || null,
      timeMin: +c_min.value || null,
      timeSec: +c_sec.value || null,
    };
  }
  else {
    const type = CONFIG[selected];
    entry = { ex: selected, type };

    if (type === "weight") {
      entry.weight = +weight.value;
      entry.sets = +sets.value;
      entry.reps = +reps.value;
      if (!entry.weight || !entry.sets || !entry.reps) return alert("필수값 입력");
    }
    if (type === "repsOnly") {
      entry.sets = +sets.value;
      entry.reps = +reps.value;
      if (!entry.sets || !entry.reps) return alert("필수값 입력");
    }
    if (type === "plank") {
      entry.sets = +sets.value;
      entry.seconds = +seconds.value;
      if (!entry.sets || !entry.seconds) return alert("필수값 입력");
    }
    if (type === "time") {
      entry.time = +time.value;
      if (!entry.time) return alert("필수값 입력");
    }
    if (type === "distanceOnly") {
      entry.dist = +distance.value;
      if (!entry.dist) return alert("필수값 입력");
    }
  }

  if (editTarget) {
    saved[editTarget.di].items[editTarget.ii] = entry;
    store();
    editTarget = null;
    addEntryBtn.textContent = "표에 추가";
    renderSaved();
    return;
  }

  todayEntries.push(entry);
  renderToday();
  renderDynamicInputs();
}

addEntryBtn.onclick = addEntry;


/* ---------------- 오늘 운동 비우기 ---------------- */
clearTodayBtn.onclick = () => {
  if (!todayEntries.length) return;
  if (!confirm("오늘 운동 삭제?")) return;
  todayEntries = [];
  renderToday();
};


/* ---------------- 포맷 ---------------- */
function formatEntry(e) {
  if (e.custom) {
    let x = `${e.ex} — `;
    if (e.weight) x += `${e.weight}kg `;
    if (e.sets && e.reps) x += `${e.sets}×${e.reps} `;
    if (e.dist) x += `${e.dist}km `;
    if (e.timeMin) x += `${e.timeMin}분 `;
    if (e.timeSec) x += `${e.timeSec}초 `;
    return x.trim();
  }

  let out = `${e.ex} — `;
  if (e.type === "weight") out += `${e.weight}kg ${e.sets}×${e.reps}`;
  if (e.type === "repsOnly") out += `${e.sets}×${e.reps}`;
  if (e.type === "plank") out += `${e.sets}×${e.seconds}초`;
  if (e.type === "time") out += `${e.time}분`;
  if (e.type === "distanceOnly") out += `${e.dist}km`;
  return out;
}


/* ---------------- 오늘 운동 출력 ---------------- */
function renderToday() {
  if (!todayEntries.length) {
    todayArea.textContent = "아직 추가된 운동 없음";
    return;
  }
  todayArea.innerHTML = todayEntries.map(e => `<div>${formatEntry(e)}</div>`).join("");
}


/* ---------------- 날짜 저장 ---------------- */
function finishDay() {
  if (!todayEntries.length) return alert("운동 없음");

  const date = dateInput.value;
  let exist = saved.find(x => x.date === date);

  if (exist) exist.items.push(...todayEntries);
  else saved.push({ date, items: [...todayEntries] });

  /* 날짜 순 정렬을 원본에 적용 → index mismatch 절대 없음 */
  saved.sort((a, b) => b.date.localeCompare(a.date));

  store();
  todayEntries = [];
  renderToday();
  renderSaved();
}
finishDayBtn.onclick = finishDay;


/* ---------------- 저장/로드 ---------------- */
function store() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
}

function load() {
  saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  /* 로드 시에도 정렬 유지 */
  saved.sort((a, b) => b.date.localeCompare(a.date));
}
load();


/* ---------------- 기록 렌더링 (문제 원인 완전 해결 버전) ---------------- */
function renderSaved() {
  const acc = logAccordion;
  acc.innerHTML = "";

  if (!saved.length) {
    acc.innerHTML = `<div style="color:#6b7280;">기록 없음</div>`;
    return;
  }

  saved.forEach((session, di) => {
    const head = document.createElement("div");
    head.className = "accordion-date";
    head.innerHTML = `${session.date}<span>▶</span>`;

    const content = document.createElement("div");
    content.className = "accordion-content";

    const groups = {};

    /* 실제 인덱스(ii)를 100% 저장 */
    session.items.forEach((e, ii) => {
      if (!groups[e.ex]) groups[e.ex] = [];
      groups[e.ex].push({ e, ii });
    });

    Object.keys(groups).forEach(exName => {
      const box = document.createElement("div");
      box.className = "exercise-group";
      box.innerHTML = `<div class="exercise-title">${exName}</div>`;

      groups[exName].forEach(obj => {
        const line = document.createElement("div");
        line.className = "exercise-line";

        line.innerHTML = `
          <span>${formatEntry(obj.e)}</span>
          <span>
            <span class="edit-btn" onclick="editEntry(${di},${obj.ii})">수정</span>
            <span class="delete-btn" onclick="deleteEntry(${di},${obj.ii})">삭제</span>
          </span>
        `;

        box.appendChild(line);
      });

      content.appendChild(box);
    });

    head.onclick = () => {
      const open = content.style.display === "flex";
      content.style.display = open ? "none" : "flex";
      head.querySelector("span").textContent = open ? "▶" : "▼";
    };

    acc.appendChild(head);
    acc.appendChild(content);
  });
}
renderSaved();


/* ---------------- 수정 ---------------- */
function editEntry(di, ii) {
  editTarget = { di, ii };
  const e = saved[di].items[ii];

  exerciseSelect.value = e.custom ? "custom" : e.ex;
  renderDynamicInputs();

  if (e.custom) {
    c_name.value = e.ex;
    c_weight.value = e.weight || "";
    c_sets.value = e.sets || "";
    c_reps.value = e.reps || "";
    c_dist.value = e.dist || "";
    c_min.value = e.timeMin || "";
    c_sec.value = e.timeSec || "";
  }
  else {
    if (e.type === "weight") {
      weight.value = e.weight;
      sets.value = e.sets;
      reps.value = e.reps;
    }
    if (e.type === "repsOnly") {
      sets.value = e.sets;
      reps.value = e.reps;
    }
    if (e.type === "plank") {
      sets.value = e.sets;
      seconds.value = e.seconds;
    }
    if (e.type === "time") time.value = e.time;
    if (e.type === "distanceOnly") distance.value = e.dist;
  }

  addEntryBtn.textContent = "수정 저장";
}


/* ---------------- 삭제 ---------------- */
function deleteEntry(di, ii) {
  if (!confirm("삭제할까요?")) return;

  saved[di].items.splice(ii, 1);
  if (saved[di].items.length === 0) saved.splice(di, 1);

  store();
  renderSaved();
}
